<HTML>
  <HEAD>
    <TITLE>draw.js</TITLE>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
      crossorigin="anonymous">
    </script>
    <SCRIPT src="https://www.tfletch.tech:8080/socket.io/socket.io.js"></SCRIPT>
    <SCRIPT>
      var socket = io();
      var isMouseDown = false;
      var data = {};
      var color = "#00ff00";
      var size = 3;
      var numOfUsers = 0;
      
      // From http://stackoverflow.com/questions/1664140/js-function-to-calculate-complementary-colour
      function hexToCompliment(hex){
        // Convert hex to rgb
        // Credit to Denis http://stackoverflow.com/a/36253499/4939630
        var rgb = 'rgb(' + (hex = hex.replace('#', '')).match(new RegExp('(.{' + hex.length/3 + '})', 'g')).map(function(l) { return parseInt(hex.length%2 ? l+l : l, 16); }).join(',') + ')';

        // Get array of RGB values
        rgb = rgb.replace(/[^\d,]/g, '').split(',');

        var r = rgb[0], g = rgb[1], b = rgb[2];

        // Convert RGB to HSL
        // Adapted from answer by 0x000f http://stackoverflow.com/a/34946092/4939630
        r /= 255.0;
        g /= 255.0;
        b /= 255.0;
        var max = Math.max(r, g, b);
        var min = Math.min(r, g, b);
        var h, s, l = (max + min) / 2.0;

        if(max == min) {
            h = s = 0;  //achromatic
        } else {
            var d = max - min;
            s = (l > 0.5 ? d / (2.0 - max - min) : d / (max + min));

            if(max == r && g >= b) {
                h = 1.0472 * (g - b) / d ;
            } else if(max == r && g < b) {
                h = 1.0472 * (g - b) / d + 6.2832;
            } else if(max == g) {
                h = 1.0472 * (b - r) / d + 2.0944;
            } else if(max == b) {
                h = 1.0472 * (r - g) / d + 4.1888;
            }
        }

        h = h / 6.2832 * 360.0 + 0;

        // Shift hue to opposite side of wheel and convert to [0-1] value
        h+= 180;
        if (h > 360) { h -= 360; }
        h /= 360;

        // Convert h s and l values into r g and b values
        // Adapted from answer by Mohsen http://stackoverflow.com/a/9493060/4939630
        if(s === 0){
            r = g = b = l; // achromatic
        } else {
            var hue2rgb = function hue2rgb(p, q, t){
                if(t < 0) t += 1;
                if(t > 1) t -= 1;
                if(t < 1/6) return p + (q - p) * 6 * t;
                if(t < 1/2) return q;
                if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            };

            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            var p = 2 * l - q;

            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
        }

        r = Math.round(r * 255);
        g = Math.round(g * 255); 
        b = Math.round(b * 255);

        // Convert r b and g values to hex
        rgb = b | (g << 8) | (r << 16); 
        return "#" + (0x1000000 | rgb).toString(16).substring(1);
      }  
      $(document).ready(function(){
        var ctx = document.getElementById("canvas").getContext("2d");
        socket.emit('getCanvas', "Load");
        function drawData(e){
          ctx.beginPath();
          ctx.fillStyle = e.c;
          ctx.fillRect(e.x-e.s/2,e.y-e.s/2,e.s,e.s);
          ctx.closePath();
        }
        function sendData(){
          socket.emit('draw', JSON.stringify(data));
          data = {};
        }
        $('#color').change(function(){
          var regex = /^[A-Fa-f0-9]+$/;
          var val = $('#color').val();
          if(regex.exec(val) == null){
            color = "#ffffff";
            $('#color').css({'background-color': '#aa2222'});
          }else{
            color = "#"+val;
            $('#color').css({'background-color': color,
                             'color': hexToCompliment(color)});
          }
        });
        $('#size').change(function(){
          size = $('#size').val()-0;
        });
        $('#download').click(function(){
          socket.emit("getCanvas", "Download");
        });
        canvas.addEventListener('mousedown',function(){
          isMouseDown = true;
        });
        canvas.addEventListener('mouseup',function(){
          isMouseDown = false;
       });
        canvas.addEventListener('mousemove',function(e){    
          if(isMouseDown){
            var obj = 
            {"x": e.offsetX,
             "y": e.offsetY,
             "c": color,
             "s": size
            };
            data[Date.now()] = obj;
            drawData(obj);
            sendData();
          }
        });
        socket.on('receive', function(json){
          var data = JSON.parse(json);
          for(var key in data){
            drawData(data[key]);
          }
        });
        socket.on('setCanvas',function(data){
          console.log("setting canvas");
          $('#canvas').css({"background-image": "url("+data+")"});
        });
        socket.on('downloadCanvas',function(data){
          // Algoritm obtained from http://stackoverflow.com/questions/3906142/how-to-save-a-png-from-javascript-variable
          var download = document.createElement('a');
          download.href = data;
          download.download = "download.png";
          download.click();
        });
      });
    </SCRIPT>
  </HEAD>
  <BODY>
    <P>Use your mouse to draw on the canvas below</P>
    <CANVAS id="canvas" width="1000" height="1000"></CANVAS>
    <div style="position: fixed;bottom:0px;left:0px;">
      <input type="range" id="size" min="1" max="100" step="2" value="3"></input>
      &nbsp;#<input type="text" id="color" style="background-color: #00ff00; color: #ff00ff;" value="00ff00"></input>
      &nbsp;<input type="button" id="download" value="Download"></input>
    </div>
  </BODY>
</HTML>
